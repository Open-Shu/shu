# Shu Configuration Example
# Copy this file to .env and modify the values as needed
#
# QUICK START:
# 1. Generate JWT secret: python -c "import secrets; print(secrets.token_urlsafe(32))"
# 2. Set up Google OAuth2 credentials in Google Cloud Console
# 3. Configure your PostgreSQL database with pgvector extension

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

# PostgreSQL connection string (REQUIRED)
# Format: postgresql://username:password@host:port/database             # pragma: allowlist secret
SHU_DATABASE_URL="postgresql+asyncpg://shu:password@localhost:5432/shu" # pragma: allowlist secret


# =============================================================================
# REDIS CONFIGURATION
# =============================================================================

# Redis connection URL (REQUIRED for background tasks and caching)
SHU_REDIS_URL="redis://localhost:6379"

# Redis client timeouts in seconds
SHU_REDIS_CONNECTION_TIMEOUT=5
SHU_REDIS_SOCKET_TIMEOUT=5

# =============================================================================
# API SERVER CONFIGURATION
# =============================================================================

# API server host address
# Security: Use 127.0.0.1 (localhost only) for development
# Use 0.0.0.0 (all interfaces) only when running in containers or when external access is required
# Production deployments should use proper reverse proxy (nginx) with 127.0.0.1
SHU_API_HOST="127.0.0.1"

# API server port (default: 8000)
SHU_API_PORT=8000

# Allowed hosts for TrustedHostMiddleware; comma-separated list. Use '*' only for local dev.
SHU_ALLOWED_HOSTS=["*"]


# Environment mode: development, staging, production (default: development)
SHU_ENVIRONMENT="development"

# Enable auto-reload for development (default: false)
SHU_RELOAD="false"

# Enable debug mode (default: false)
SHU_DEBUG="false"

# Renames UI elements
SHU_APP_NAME="Shu"

# =============================================================================
# BRANDING CONFIGURATION
# =============================================================================

# Directory where branding assets are stored (default: ./data/branding)
SHU_BRANDING_ASSETS_DIR="./data/branding"

# Default favicon URL for light theme (default: /favicon-dark.png)
SHU_BRANDING_DEFAULT_FAVICON_URL="/favicon-dark.png"

# Default favicon URL for dark theme (default: /favicon-dark.png)
SHU_BRANDING_DEFAULT_DARK_FAVICON_URL="/favicon-dark.png"

# Allowed file extensions for favicon uploads (JSON array)
SHU_BRANDING_ALLOWED_FAVICON_EXTENSIONS=["ico", "png", "svg", "webp"]

# Maximum asset file size in bytes (default: 2MB)
SHU_BRANDING_MAX_ASSET_SIZE_BYTES=2097152

# =============================================================================
# BUILD / RELEASE METADATA (managed by build pipeline)
# =============================================================================
# These are set by the Makefile (local) or GitHub Actions (CI) at build time.
# Do NOT set manually when building via SemVer tags and CI; values are baked into images.
# For local testing without tags/CI, you may set them explicitly.
SHU_APP_VERSION=
SHU_GIT_SHA=
SHU_BUILD_TIMESTAMP=
SHU_DB_RELEASE=

# LOGGING CONFIGURATION
# =============================================================================

# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL (default: INFO)
SHU_LOG_LEVEL="INFO"

# Log format: text (human-readable) or json (structured) (default: text)
SHU_LOG_FORMAT="text"

# Log directory (default: ./data/logs, resolved relative to repo root)
# In containers this resolves to /app/data/logs
SHU_LOG_DIR="./data/logs"

# Number of days to retain rotated log files (default: 14)
# Logs rotate at midnight (UTC) and on each process startup.
SHU_LOG_RETENTION_DAYS=14

# =============================================================================
# EMBEDDING MODEL CONFIGURATION
# =============================================================================

# Embedding model name (default: all-MiniLM-L6-v2)
SHU_EMBEDDING_MODEL="all-MiniLM-L6-v2"


# Max concurrent OCR jobs (default: 1)
# OCR is CPU/memory-intensive (EasyOCR loads ~1.5-2.5 GiB of models).
# Keep low to avoid OOM on memory-constrained nodes.
SHU_OCR_MAX_CONCURRENT_JOBS=1

# OCR per-page timeout in seconds (default: 180)
# Increase if processing complex/large pages or running with high concurrency.
SHU_OCR_PAGE_TIMEOUT=180

# Embedding dimension (default: 384)
SHU_EMBEDDING_DIMENSION=384

# Embedding batch size (number of chunks per encode call; default: 32)
SHU_EMBEDDING_BATCH_SIZE=32


# Embedding execution mode (default: thread)
# Allowed values:
#   thread  - run embeddings in-thread within the API process using a ThreadPoolExecutor (optimized path)
#   process - run embeddings in a separate ProcessPoolExecutor (heavier isolation; currently unstable)
SHU_EMBEDDING_EXECUTION_MODE="thread"


# =============================================================================
# TEXT PROCESSING CONFIGURATION
# =============================================================================

# Default chunk size in characters (default: 1000)
SHU_DEFAULT_CHUNK_SIZE=1000

# Default chunk overlap in characters (default: 200)
SHU_DEFAULT_CHUNK_OVERLAP=200

# =============================================================================
# VECTOR DATABASE CONFIGURATION
# =============================================================================

# Vector index type: ivfflat, hnsw (default: ivfflat)
SHU_VECTOR_INDEX_TYPE="ivfflat"

# Number of lists for IVFFlat index (default: 100)
SHU_VECTOR_INDEX_LISTS=100

# =============================================================================
# SYNC & BACKGROUND TASKS CONFIGURATION
# =============================================================================

# Sync operation timeout in seconds (default: 3600)
SHU_SYNC_TIMEOUT=3600

# Number of retry attempts for failed sync operations (default: 3)
SHU_SYNC_RETRY_ATTEMPTS=3

# =============================================================================
# WORKER CONFIGURATION
# =============================================================================

# Enable background workers in this process (default: true)
# - true: Workers run within the API process (simpler, single-process deployment)
# - false: Workers disabled; use separate worker processes (`python -m shu.worker`)
SHU_WORKERS_ENABLED=true

# Number of concurrent worker tasks per process (default: 10)
# Higher values improve throughput for I/O-bound jobs (LLM calls, API requests).
# All workers compete for jobs from the same queues.
# Recommended: 8-16 for I/O-bound workloads, lower for CPU-bound work.
SHU_WORKER_CONCURRENCY=10

# Seconds between queue poll attempts when no jobs are available (default: 1.0)
# Lower values reduce job pickup latency but increase Redis/CPU load when idle.
# Higher values conserve resources but delay job processing.
SHU_WORKER_POLL_INTERVAL=1.0

# Seconds to wait for current job to complete during graceful shutdown (default: 30.0)
# Should align with Kubernetes terminationGracePeriodSeconds in production.
# Jobs exceeding this timeout will be forcefully terminated.
SHU_WORKER_SHUTDOWN_TIMEOUT=30.0

# File staging TTL in seconds for document ingestion pipeline (default: 3600 = 1 hour)
# Staged files are automatically cleaned up after this duration if not retrieved.
SHU_FILE_STAGING_TTL=3600


# Plugin Feeds Scheduler
SHU_PLUGINS_SCHEDULER_ENABLED=true
SHU_PLUGINS_SCHEDULER_TICK_SECONDS=60
SHU_PLUGINS_SCHEDULER_BATCH_LIMIT=10
# Timeout in seconds to mark RUNNING executions as stale and fail them (default 3600 = 1 hour)
SHU_PLUGINS_SCHEDULER_RUNNING_TIMEOUT_SECONDS=3600
# Default backoff (seconds) when deferring on 429 rate/concurrency limits
SHU_PLUGINS_SCHEDULER_RETRY_BACKOFF_SECONDS=5



# =============================================================================
# AUTHENTICATION & SECURITY CONFIGURATION
# =============================================================================

# JWT Secret Key for signing tokens (REQUIRED for authentication)
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
JWT_SECRET_KEY="your-jwt-secret-key-here"       # pragma: allowlist secret

# JWT token expiration settings
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=60
JWT_REFRESH_TOKEN_EXPIRE_DAYS=30

# Google OAuth2 Configuration (REQUIRED for authentication)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=               # pragma: allowlist secret
# DEPRECATED: Use OAUTH_REDIRECT_URI instead. Will be removed in a future release.
# GOOGLE_REDIRECT_URI="http://localhost:8000/auth/callback"

# Microsoft 365 OAuth
MICROSOFT_CLIENT_ID=
MICROSOFT_CLIENT_SECRET=            # pragma: allowlist secret
MICROSOFT_TENANT_ID=common

# Unified OAuth Redirect URI (used by all OAuth providers: Google, Microsoft, etc.)
# All providers share the same callback endpoint which identifies the provider via state parameter
OAUTH_REDIRECT_URI="http://localhost:8000/auth/callback"

# Admin Email Configuration (OPTIONAL)
# Comma-separated list of email addresses that should be granted admin access
# The first user to log in will automatically be made an admin regardless of this list
ADMIN_EMAILS=["admin@yourcompany.com","another-admin@yourcompany.com"]

# Auto-activate new users on first SSO login (default: false)
# WARNING: Only enable in trusted environments (internal teams, dev setups).
# When false, new non-admin users require manual admin activation.
SHU_AUTO_ACTIVATE_USERS=false

# Global API key (Tier 0) for service-to-service access
SHU_API_KEY=""
# When using SHU_API_KEY, map it to this user's email for RBAC context
SHU_API_KEY_USER_EMAIL=""
SHU_SECRET_KEY=""               # pragma: allowlist secret

# Password policy: moderate (default) or strict
# moderate: min 8 chars, uppercase, lowercase, number
# strict: all moderate rules + at least one special character
SHU_PASSWORD_POLICY="moderate"               # pragma: allowlist secret
SHU_PASSWORD_MIN_LENGTH=8

# =============================================================================
# LLM INTEGRATION CONFIGURATION
# =============================================================================

# LLM Encryption Key for secure API key storage (REQUIRED for LLM features)
# Generate with: python -c "from cryptography.fernet import Fernet; print(f'SHU_LLM_ENCRYPTION_KEY={Fernet.generate_key().decode()}')"
SHU_LLM_ENCRYPTION_KEY="your-fernet-encryption-key-here"

# OAuth Token Encryption Key for secure OAuth token storage (REQUIRED for OAuth features)
# Generate with: python -c "from cryptography.fernet import Fernet; print(f'SHU_OAUTH_ENCRYPTION_KEY={Fernet.generate_key().decode()}')"
SHU_OAUTH_ENCRYPTION_KEY="your-oauth-fernet-encryption-key-here"

# Fallback OpenAI provider (OPTIONAL)
# Used only when no providers are configured in the database.
# Set OPENAI_API_KEY to enable fallback. Default model used below.
OPENAI_API_KEY="sk-your-openai-api-key-here"    # pragma: allowlist secret

# Default model name for fallback provider
SHU_DEFAULT_LLM_MODEL="gpt-4"

# Global LLM System Limits (OPTIONAL - system-wide defaults)
SHU_LLM_STREAMING_READ_TIMEOUT=120
SHU_LLM_GLOBAL_TIMEOUT=30
SHU_LLM_MAX_TOKENS_DEFAULT=50000
SHU_LLM_TEMPERATURE_DEFAULT=0.7

# NOTE: LLM rate limits (RPM/TPM) are per-provider, configured via admin interface
# Production LLM providers should be configured through the admin interface
# The database-driven configuration provides better security, monitoring, and control
# Environment variables above are primarily for development and fallback scenarios

# =============================================================================
# RAG CONFIGURATION DEFAULTS (GLOBAL FALLBACKS)
# =============================================================================

# These provide system-wide defaults when no KB-specific configuration exists
# In production, configure these through the Knowledge Base admin interface

# =============================================================================
# DOCUMENT PROFILING (SHU RAG Phase 1B)
# =============================================================================

# Enable document/chunk profiling at ingestion time (default: false)
SHU_ENABLE_DOCUMENT_PROFILING="false"

# Routing threshold for document-level profiling strategy (default: 4000)
# Documents with token count <= this value use full-document profiling in a single
# LLM call. Larger documents use chunk-first aggregation to derive document-level
# profiles from chunk profiles. UI-configurable in future.
SHU_PROFILING_FULL_DOC_MAX_TOKENS=4000

# Hard ceiling on any single profiling LLM call (default: 8000)
# Applies to both full-document calls and aggregate calls over chunk profiles.
# Never truncate documents to satisfy this; instead route to chunk-first
# aggregation or partition aggregate calls.
SHU_PROFILING_MAX_INPUT_TOKENS=8000

# Timeout for profiling LLM calls in seconds (default: 60)
SHU_PROFILING_TIMEOUT_SECONDS=60

# Batch size for chunk profiling (default: 10)
SHU_CHUNK_PROFILING_BATCH_SIZE=10

# Max concurrent profiling tasks to prevent LLM rate-limit storms (default: 5)
# During bulk imports, tasks beyond this limit queue in memory until a slot opens.
# See SHU-211 for planned migration to persistent work queue.
SHU_PROFILING_MAX_CONCURRENT_TASKS=5

# =============================================================================

# Default search similarity threshold (0.0-1.0, default: 0.7)
SHU_RAG_SEARCH_THRESHOLD_DEFAULT=0.7

# Default maximum results to return (default: 10)
SHU_RAG_MAX_RESULTS_DEFAULT=10

# Default chunk overlap ratio for context continuity (0.0-0.5, default: 0.2)
SHU_RAG_CHUNK_OVERLAP_RATIO_DEFAULT=0.2

# Default search type: similarity, keyword, hybrid (default: hybrid)
SHU_RAG_SEARCH_TYPE_DEFAULT="hybrid"

# Default context format: detailed, simple (default: detailed)
SHU_RAG_CONTEXT_FORMAT_DEFAULT="detailed"

# Default reference format: markdown, text (default: markdown)
SHU_RAG_REFERENCE_FORMAT_DEFAULT="markdown"

# Default include references in responses (default: true)
SHU_RAG_INCLUDE_REFERENCES_DEFAULT="true"

# Default prompt template type: academic, business, technical, custom (default: custom)

# Full Document Escalation Defaults
# When enabled, the system can escalate to embedding full documents in context
SHU_RAG_FULL_DOC_FETCH_DEFAULT="false"
SHU_RAG_FULL_DOC_MAX_DOCS_DEFAULT=2
# This cap is intended to be close to the model's context window for legal/patent use-cases
SHU_RAG_FULL_DOC_TOKEN_CAP_DEFAULT=80000

SHU_RAG_PROMPT_TEMPLATE_DEFAULT="custom"

# Hybrid Search Configuration (global defaults)
SHU_HYBRID_SIMILARITY_WEIGHT_DEFAULT=0.7
SHU_HYBRID_KEYWORD_WEIGHT_DEFAULT=0.3

# Title Search Configuration (global defaults)
SHU_TITLE_WEIGHTING_ENABLED_DEFAULT=true
SHU_TITLE_WEIGHT_MULTIPLIER_DEFAULT=3.0
SHU_TITLE_CHUNK_ENABLED_DEFAULT=true

# Document Chunk Configuration (global defaults)
SHU_MAX_CHUNKS_PER_DOCUMENT_DEFAULT=2

# Query Processing Configuration (global defaults)
SHU_RAG_MINIMUM_QUERY_WORDS_DEFAULT=3

# =============================================================================
# USER PREFERENCES DEFAULTS (LEGITIMATE USER SETTINGS)
# =============================================================================

# These control what users can configure vs admin-only settings
# Users can only modify their personal preferences, not system behavior

# Default memory depth for cross-session memory (1-20, default: 5)
SHU_USER_MEMORY_DEPTH_DEFAULT=5

# Default memory similarity threshold (0.0-1.0, default: 0.6)
SHU_USER_MEMORY_SIMILARITY_THRESHOLD_DEFAULT=0.6

# Default cross-session memory enabled state (default: false)
SHU_USER_ENABLE_CROSS_SESSION_MEMORY_DEFAULT="false"

# Default UI theme: light, dark, auto (default: auto)
SHU_USER_THEME_DEFAULT="auto"

# Default language code: en, es, fr, etc. (default: en)
SHU_USER_LANGUAGE_DEFAULT="en"

# Default timezone: UTC, America/New_York, etc. (default: UTC)
SHU_USER_TIMEZONE_DEFAULT="UTC"

# =============================================================================
# GOOGLE DRIVE INTEGRATION (OPTIONAL)
# =============================================================================

# Path to Google service account JSON file
# Required for Google Drive source type in knowledge bases
GOOGLE_SERVICE_ACCOUNT_JSON="./google-service-account.json"

# =============================================================================
# GOOGLE WORKSPACE ADMIN (OPTIONAL)
# =============================================================================
# Admin user email used for domain-wide delegation with Admin Directory API
# Needed to resolve Google Chat participant IDs to names/emails in Morning Briefing
# Service account must be granted scope:
#   https://www.googleapis.com/auth/admin.directory.user.readonly
GOOGLE_ADMIN_USER_EMAIL="admin@your-domain.com" # only needed for Admin Directory API integration tests

# Optional: Restrict host.auth google_service_account_token subjects to this domain
GOOGLE_DOMAIN="your-domain.com"

# =============================================================================
# PLUGINS (UPLOAD & DISCOVERY)
# =============================================================================
# Root directory where plugins are discovered and installed.
# Relative paths are resolved from the repository root.
SHU_PLUGINS_ROOT="./data/plugins"



# =============================================================================
# API RATE LIMITING (HTTP Request Throttling)
# =============================================================================
# These settings control rate limiting for HTTP API requests (not LLM calls).
# For LLM provider rate limits (RPM/TPM), see LLM PROVIDER RATE LIMITING below.

# Enable API rate limiting (default: false - disabled for development)
# Set to true in production to enable HTTP request throttling
SHU_ENABLE_API_RATE_LIMITING=false

# Global API rate limiting (requests per period)
SHU_API_RATE_LIMIT_REQUESTS=100
SHU_API_RATE_LIMIT_PERIOD=60

# Per-user API rate limiting (requests per period per user)
SHU_API_RATE_LIMIT_USER_REQUESTS=50
SHU_API_RATE_LIMIT_USER_PERIOD=60

# =============================================================================
# LLM PROVIDER RATE LIMITING (Defaults for new providers)
# =============================================================================
# These are default values used when creating new LLM providers.
# Per-provider overrides are configured in the admin UI and stored in the database.
# Set to 0 for unlimited (no rate limiting).

SHU_LLM_RATE_LIMIT_RPM_DEFAULT=0
SHU_LLM_RATE_LIMIT_TPM_DEFAULT=0



# =============================================================================
# HOST CAPABILITIES - HTTP EGRESS POLICY (PLUGINS)
# =============================================================================
# Comma-separated domains/hosts allowed for plugin egress via host.http.
# In development, leaving this empty allows all egress. In staging/production,
# you should explicitly list required domains only.
# Examples: "oauth2.googleapis.com,gmail.googleapis.com"
SHU_HTTP_EGRESS_ALLOWLIST=""

# Default network timeout in seconds for host.http requests
SHU_HTTP_DEFAULT_TIMEOUT=30

# =============================================================================
# PLUGINS
# =============================================================================
# Auto-register discovered plugins into the DB registry at startup
# If enabled, new plugins are inserted as disabled (admin must enable them)
SHU_PLUGINS_AUTO_SYNC="true"

# Quotas (per user per plugin)
SHU_PLUGIN_QUOTA_DAILY_REQUESTS_DEFAULT=0
SHU_PLUGIN_QUOTA_MONTHLY_REQUESTS_DEFAULT=0

# Enable chat plugin calling (disabled by default; enable when Chat M1 slice resumes)
SHU_CHAT_PLUGINS_ENABLED="false"

# =============================================================================
# CHAT ATTACHMENTS
# =============================================================================

# Maximum single attachment size in bytes (default: 20 MB)
SHU_CHAT_ATTACHMENT_MAX_SIZE=20971520

# Allowed attachment MIME types/extensions
SHU_CHAT_ATTACHMENT_ALLOWED_TYPES=["pdf", "docx", "txt", "md", "png", "jpg", "jpeg", "gif", "webp"]

# Attachment retention in days
SHU_CHAT_ATTACHMENT_TTL_DAYS=14

# Directory to store uploaded attachments
SHU_CHAT_ATTACHMENT_STORAGE_DIR="./data/attachments"

# Maximum characters processed per file and total across all files
SHU_CHAT_ATTACHMENT_MAX_CHARS_PER_FILE=5000
SHU_CHAT_ATTACHMENT_MAX_TOTAL_CHARS=15000

# Cleanup interval in seconds for expired attachments
SHU_CHAT_ATTACHMENT_CLEANUP_INTERVAL_SECONDS=21600

# =============================================================================
# CONVERSATION AUTOMATION
# =============================================================================

# Conversation automation defaults
SHU_CONVERSATION_SUMMARY_PROMPT=
SHU_CONVERSATION_SUMMARY_TIMEOUT_MS=5000
SHU_CONVERSATION_SUMMARY_MAX_RECENT_MESSAGES=10
SHU_CONVERSATION_AUTO_RENAME_PROMPT=
SHU_CONVERSATION_AUTO_RENAME_TIMEOUT_MS=5000
SHU_CONVERSATION_SUMMARY_SEARCH_MIN_TOKEN_LENGTH=3
SHU_CONVERSATION_SUMMARY_SEARCH_MAX_TOKENS=10


# Strict API Rate Limiting (for auth endpoints - brute force protection)
SHU_STRICT_API_RATE_LIMIT_REQUESTS=10
SHU_STRICT_API_RATE_LIMIT_USER_REQUESTS=5
SHU_MAX_PAGINATION_LIMIT=1000

# =============================================================================
# REQUEST SIZE LIMITS
# =============================================================================

# Maximum query length in characters (default: 10000)
SHU_MAX_QUERY_LENGTH=10000

# Maximum file size in bytes (default: 50MB)
SHU_MAX_FILE_SIZE=52428800

# Maximum batch size for operations (default: 100)
SHU_MAX_BATCH_SIZE=100

# Maximum request body size in bytes (default: 10MB)
SHU_MAX_REQUEST_SIZE=10485760

# Maximum plugin execution input JSON size in bytes (0 disables)
SHU_PLUGIN_EXEC_INPUT_MAX_BYTES=262144
# Maximum plugin execution output JSON size in bytes (0 disables)
SHU_PLUGIN_EXEC_OUTPUT_MAX_BYTES=1048576


# =============================================================================
# DEVELOPMENT CONFIGURATION
# =============================================================================

# Python path for development (optional)
PYTHONPATH="$(pwd)/src"

# =============================================================================
# DEPLOYMENT NOTES
# =============================================================================

# For production deployment:
# 1. Set SHU_ENVIRONMENT="production"
# 2. Set SHU_DEBUG="false"
# 3. Configure proper database credentials
# 4. Generate secure JWT_SECRET_KEY
# 5. Set up Google OAuth2 credentials
# 6. Configure external PostgreSQL with pgvector extension
# 7. Set up proper logging and monitoring
# 8. Configure knowledge base sources through admin interface

# For Kubernetes deployment:
# 1. Use environment variables in deployment YAML
# 2. Configure secrets for sensitive data
# 3. Set up proper health checks
# 4. Configure resource limits

# For Docker deployment:
# 1. Use docker-compose.yml for local development
# 2. Use Dockerfile for production builds
# 3. Configure external database connection
# 4. Set up proper volume mounts for data persistence

# =============================================================================
# DOCKER DEVELOPMENT ENVIRONMENT
# =============================================================================
# These variables are already set in docker-compose.yml for Docker dev.
# They are listed here for reference only â€” you do NOT need to uncomment them.
# Setting them in .env while also running docker-compose may cause conflicts.

# OAuth Redirect URI for Docker dev (frontend proxies to backend)
# OAUTH_REDIRECT_URI=http://localhost:3000/auth/callback

# Vite Dev Server Proxy Target (Docker dev only, server-side)
# DEV_SERVER_API_PROXY_TARGET=http://shu-api-dev:8000

# Frontend API Base URL (optional, for local non-Docker dev)
# VITE_API_BASE_URL=http://localhost:8000

# Note: In Docker dev, use DEV_SERVER_API_PROXY_TARGET instead of VITE_API_BASE_URL.
# In Docker prod, VITE_API_BASE_URL is baked into the static build at build time.
# See docs/deployment/DOCKER_FRONTEND_NETWORKING.md for details.
